{% liquid
  assign product_card_image = product.featured_media | default: product.media[0]
  assign on_sale = false
  if product.compare_at_price > product.price
    assign on_sale = true
  endif
  assign sold_out = true
  if product.available
    assign sold_out = false
  endif
%}

<div class="card-product group relative bg-white rounded-lg shadow-sm border hover:shadow-lg transition-all duration-300">
  <div class="card-product__media relative overflow-hidden rounded-t-lg">
    {% if product_card_image %}
      <a href="{{ product.url }}" class="block">
        <img
          src="{{ product_card_image | image_url: width: 400 }}"
          alt="{{ product_card_image.alt | escape }}"
          loading="lazy"
          width="400"
          height="400"
          class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-300"
        >
      </a>
    {% else %}
      <div class="w-full h-64 bg-gray-200 flex items-center justify-center">
        <svg class="w-16 h-16 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
        </svg>
      </div>
    {% endif %}

    {% comment %} Product badges {% endcomment %}
    <div class="card-product__badges absolute top-3 left-3 flex flex-col gap-2">
      {% if on_sale %}
        <span class="badge badge--sale bg-red-600 text-white px-2 py-1 text-xs font-semibold rounded">
          Sale
        </span>
      {% endif %}
      {% if sold_out %}
        <span class="badge badge--sold-out bg-gray-600 text-white px-2 py-1 text-xs font-semibold rounded">
          Sold Out
        </span>
      {% endif %}
      {% if product.tags contains 'new' %}
        <span class="badge badge--new bg-green-600 text-white px-2 py-1 text-xs font-semibold rounded">
          New
        </span>
      {% endif %}
    </div>

    {% comment %} Quick actions {% endcomment %}
    <div class="card-product__actions absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
      <button class="action-btn bg-white hover:bg-gray-50 w-8 h-8 rounded-full shadow-md flex items-center justify-center transition-colors" aria-label="Add to wishlist">
        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
        </svg>
      </button>
    </div>

    {% comment %} Quick add to cart button {% endcomment %}
    {% unless sold_out %}
      <div class="card-product__quick-add absolute bottom-3 left-3 right-3 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
        <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data">
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
          <button 
            type="submit"
            class="quick-add-btn w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded font-medium transition-colors"
            {% if sold_out %}disabled{% endif %}
          >
            {% if sold_out %}
              Sold Out
            {% else %}
              Quick Add
            {% endif %}
          </button>
        </form>
      </div>
    {% endunless %}
  </div>

  <div class="card-product__content p-4">
    {% comment %} Vendor {% endcomment %}
    {% if show_vendor and product.vendor != blank %}
      <div class="card-product__vendor text-sm text-gray-500 mb-1">
        {{ product.vendor }}
      </div>
    {% endif %}

    {% comment %} Product title {% endcomment %}
    <h3 class="card-product__title text-lg font-semibold mb-2 leading-tight">
      <a href="{{ product.url }}" class="text-gray-900 hover:text-red-600 transition-colors">
        {{ product.title | truncate: 50 }}
      </a>
    </h3>

    {% comment %} Product rating (if reviews exist) {% endcomment %}
    {% if product.metafields.reviews.rating_value %}
      <div class="card-product__rating flex items-center mb-2">
        <div class="flex items-center">
          {% assign rating = product.metafields.reviews.rating_value | times: 1.0 %}
          {% for i in (1..5) %}
            {% if i <= rating %}
              <svg class="w-4 h-4 text-yellow-400 fill-current" viewBox="0 0 20 20">
                <path d="M10 15l-5.878 3.09 1.123-6.545L0 6.91l6.564-.955L10 0l3.436 5.955L20 6.91l-5.245 4.635L15.878 18z"/>
              </svg>
            {% else %}
              <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                <path d="M10 15l-5.878 3.09 1.123-6.545L0 6.91l6.564-.955L10 0l3.436 5.955L20 6.91l-5.245 4.635L15.878 18z"/>
              </svg>
            {% endif %}
          {% endfor %}
        </div>
        {% if product.metafields.reviews.rating_count %}
          <span class="text-sm text-gray-500 ml-2">({{ product.metafields.reviews.rating_count }})</span>
        {% endif %}
      </div>
    {% endif %}

    {% comment %} Product price {% endcomment %}
    <div class="card-product__price mb-3">
      {% if on_sale %}
        <div class="flex items-center space-x-2">
          <span class="text-lg font-bold text-red-600">
            {{ product.price | money }}
          </span>
          <span class="text-sm text-gray-500 line-through">
            {{ product.compare_at_price | money }}
          </span>
          {% assign savings = product.compare_at_price | minus: product.price %}
          {% assign savings_percent = savings | times: 100 | divided_by: product.compare_at_price %}
          <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">
            Save {{ savings_percent }}%
          </span>
        </div>
      {% else %}
        <span class="text-lg font-bold text-gray-900">
          {{ product.price | money }}
        </span>
      {% endif %}
    </div>

    {% comment %} Product description excerpt {% endcomment %}
    {% if product.description != blank %}
      <p class="card-product__description text-sm text-gray-600 mb-3 line-clamp-2">
        {{ product.description | strip_html | truncate: 100 }}
      </p>
    {% endif %}

    {% comment %} Product variants (if color/size options) {% endcomment %}
    {% if product.options.size > 1 and product.options[0] != 'Title' %}
      <div class="card-product__variants mb-3">
        {% assign first_option = product.options[0] %}
        {% if first_option contains 'Color' or first_option contains 'colour' %}
          <div class="variant-colors flex space-x-1">
            {% assign color_values = '' %}
            {% for variant in product.variants limit: 5 %}
              {% unless color_values contains variant.option1 %}
                {% assign color_values = color_values | append: variant.option1 | append: ',' %}
                <div 
                  class="variant-color w-6 h-6 rounded-full border-2 border-gray-300 cursor-pointer hover:border-gray-400 transition-colors"
                  style="background-color: {{ variant.option1 | downcase }}"
                  title="{{ variant.option1 }}"
                ></div>
              {% endunless %}
            {% endfor %}
          </div>
        {% else %}
          <div class="text-xs text-gray-500">
            {{ product.options.size }} option{% if product.options.size > 1 %}s{% endif %} available
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .card-product:hover .card-product__quick-add {
    transform: translateY(0);
  }
</style>